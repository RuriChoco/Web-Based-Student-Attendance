<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <title>Student Dashboard - Attendance System</title>
    <link rel="icon" href="/icons/school-icon.jpeg" />
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        .announcement-card {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .announcement-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            display: block;
        }
        .stat-box {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }
        /* Calendar Customization */
        .fc {
            font-family: 'Inter', sans-serif;
            --fc-border-color: var(--border-color);
            --fc-button-bg-color: var(--primary);
            --fc-button-border-color: var(--primary);
            --fc-button-hover-bg-color: var(--primary-dark);
            --fc-button-hover-border-color: var(--primary-dark);
            --fc-button-active-bg-color: var(--primary-dark);
            --fc-button-active-border-color: var(--primary-dark);
            --fc-today-bg-color: #f8fafc;
        }
        .fc-toolbar-title {
            font-size: 1.1rem !important;
            font-weight: 600;
        }
        .fc-button {
            font-size: 0.85rem !important;
            font-weight: 500 !important;
            padding: 6px 12px !important;
            border-radius: 6px !important;
            text-transform: capitalize !important;
        }
        .fc-col-header-cell {
            background-color: #f1f5f9;
            padding: 8px 0;
        }
        .fc-col-header-cell-cushion {
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
            color: var(--text-secondary);
            text-decoration: none !important;
        }
        .fc-daygrid-day-number {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
            text-decoration: none !important;
            padding: 8px !important;
        }
        .fc-daygrid-event {
            border-radius: 4px !important;
            padding: 2px 4px !important;
            font-size: 0.75rem !important;
            border: none !important;
            margin-top: 2px !important;
            cursor: pointer;
        }
        
        /* Legend */
        .calendar-legend {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .dot.present { background-color: var(--green); }
        .dot.absent { background-color: var(--red); }
        .dot.late { background-color: var(--orange); }

        @media (max-width: 600px) {
            .fc-header-toolbar {
                flex-direction: column;
                gap: 10px;
            }
            /* Reorder toolbar for mobile: Title on top, then Nav, then Views */
            .fc-toolbar-chunk:nth-child(2) { order: 1; }
            .fc-toolbar-chunk:nth-child(1) { order: 2; width: 100%; display: flex; justify-content: space-between; }
            .fc-toolbar-chunk:nth-child(3) { order: 3; width: 100%; display: flex; justify-content: center; }

            .calendar-legend {
                display: none; 
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>Student Portal</h3>
                <span class="role-badge">Student</span>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-link active" data-section="dashboard">Dashboard</a>
                <a href="#" class="nav-link" data-section="calendar">Calendar</a>
                <a href="#" class="nav-link" data-section="excuses">Excuses</a>
                <a href="#" class="nav-link" data-section="settings">Settings</a>
            </nav>
            <div class="sidebar-footer">
                <button id="logoutBtn" class="btn btn-red">Logout</button>
            </div>
        </aside>
        <main class="main-content">
            <header class="mobile-header">
                <button id="menuToggleBtn" class="menu-toggle">
                    <span></span><span></span><span></span>
                </button>
                <h3>Dashboard</h3>
            </header>
            
            <div id="dynamicContentContainer">
                <!-- Dashboard Section -->
                <div id="dashboardSection">
                    <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <h3 style="color: white; margin-bottom: 5px;">Mark Attendance</h3>
                                <p style="color: rgba(255,255,255,0.9); margin: 0;">Enter the session code to record your presence.</p>
                            </div>
                            <button id="openMarkAttendanceBtn" class="btn" style="background: white; color: var(--primary-dark); font-weight: bold; border: none; padding: 12px 24px;">Enter Code &rarr;</button>
                        </div>
                    </div>

                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <h2 id="welcomeMsg" style="margin: 0;">Welcome!</h2>
                            <button id="downloadPdfBtn" class="btn btn-green" style="font-size: 13px; padding: 8px 12px;">Download Report (PDF)</button>
                        </div>
                        <p style="margin-top: 10px;">Here is your attendance summary.</p>
                        <div class="stats-grid" style="margin-top: 20px;">
                            <div class="stat-box">
                                <div class="stat-number" id="statPresent">0</div>
                                <div>Present</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number" id="statAbsent" style="color: var(--red);">0</div>
                                <div>Absent</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number" id="statLate" style="color: var(--orange);">0</div>
                                <div>Late</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Announcements</h3>
                        <div id="announcementsContainer">
                            <div class="loader">Loading announcements...</div>
                        </div>
                    </div>
                </div>

                <!-- Calendar Section -->
                <div id="calendarSection" style="display: none;">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                            <h3 style="margin: 0;">Attendance Calendar</h3>
                            <div class="calendar-legend">
                                <span class="legend-item"><span class="dot present"></span> Present</span>
                                <span class="legend-item"><span class="dot absent"></span> Absent</span>
                                <span class="legend-item"><span class="dot late"></span> Late</span>
                            </div>
                        </div>
                        <div id="attendanceCalendar"></div>
                    </div>
                </div>

                <!-- Excuses Section -->
                <div id="excusesSection" style="display: none;">
                    <div class="card">
                        <h3>Submit Excuse Letter</h3>
                        <form id="excuseForm">
                            <div class="form-group">
                                <label>Date of Absence</label>
                                <input type="date" id="excuseDate" required>
                            </div>
                            <div class="form-group">
                                <label>Reason</label>
                                <textarea id="excuseReason" required placeholder="Explain why you were absent..." style="min-height: 100px;"></textarea>
                            </div>
                            <button type="submit" class="btn btn-green">Submit Excuse</button>
                        </form>
                    </div>
                    <div class="card">
                        <h3>My Excuses</h3>
                        <div class="table-wrapper">
                            <table id="excusesTable"><thead><tr><th>Date</th><th>Reason</th><th>Status</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settingsSection" style="display: none;">
                    <div class="card">
                        <h3>Change Password</h3>
                        <form id="changePasswordForm">
                            <div class="form-group">
                                <label>Current Password</label>
                                <input type="password" id="currentPassword" required>
                            </div>
                            <div class="form-group">
                                <label>New Password</label>
                                <input type="password" id="newPassword" required>
                            </div>
                            <div class="form-group">
                                <label>Confirm New Password</label>
                                <input type="password" id="confirmPassword" required>
                            </div>
                            <button type="submit" class="btn btn-green">Update Password</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div id="toastContainer"></div>

    <!-- Mark Attendance Modal -->
    <div id="markAttendanceModal" class="modal" style="display:none;">
        <div class="modal-content" style="text-align: center; max-width: 400px;">
            <h3 style="margin-bottom: 10px;">Mark Attendance</h3>
            <div id="digitalClock" class="digital-clock">--:--:--</div>
            <p style="color: var(--text-secondary); margin-bottom: 20px;" id="currentDate">Loading date...</p>
            
            <form id="markAttendanceForm">
                <div class="form-group">
                    <input type="text" id="attendanceCode" class="attendance-input" placeholder="X7Z9A2" maxlength="6" required autocomplete="off">
                </div>
                <div class="form-row" style="justify-content: center; gap: 10px; margin-top: 20px;">
                    <button type="button" id="closeMarkAttendanceBtn" class="btn" style="background-color: var(--text-secondary);">Cancel</button>
                    <button type="submit" class="btn btn-green">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { apiFetch, showMessage, getLoadingHTML } from './utils.js';

        document.addEventListener('DOMContentLoaded', async () => {
            // Check Session
            const sessionRes = await apiFetch('/api/session');
            if (!sessionRes || !sessionRes.success || !sessionRes.data.authenticated) {
                window.location.href = '/login.html';
                return;
            }
            const user = sessionRes.data.user;
            document.getElementById('welcomeMsg').textContent = `Welcome, ${user.name}!`;

            // Sidebar Toggle Logic
            const sidebar = document.querySelector('.sidebar');
            const menuToggleBtn = document.getElementById('menuToggleBtn');
            let sidebarOverlay = null;

            const toggleSidebar = () => {
                sidebar.classList.toggle('open');
                menuToggleBtn.classList.toggle('open');
                document.body.classList.toggle('no-scroll');
                
                if (sidebar.classList.contains('open')) {
                    if (!sidebarOverlay) {
                        sidebarOverlay = document.createElement('div');
                        sidebarOverlay.className = 'sidebar-overlay';
                        sidebarOverlay.addEventListener('click', toggleSidebar);
                        document.body.appendChild(sidebarOverlay);
                    }
                    sidebarOverlay.style.display = 'block';
                } else {
                    if (sidebarOverlay) sidebarOverlay.style.display = 'none';
                }
            };

            if (menuToggleBtn) menuToggleBtn.addEventListener('click', toggleSidebar);

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                await apiFetch('/api/logout', { method: 'POST' });
                window.location.href = '/login.html';
            });

            // Navigation Logic
            const navLinks = document.querySelectorAll('.sidebar-nav .nav-link');
            const sections = {
                'dashboard': document.getElementById('dashboardSection'),
                'calendar': document.getElementById('calendarSection'),
                'excuses': document.getElementById('excusesSection'),
                'settings': document.getElementById('settingsSection')
            };

            let calendar;

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Close sidebar on mobile if open
                    if (window.innerWidth <= 992 && sidebar.classList.contains('open')) {
                        toggleSidebar();
                    }
                    // Update active link
                    navLinks.forEach(l => l.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    // Show target section
                    const target = e.target.dataset.section;
                    Object.values(sections).forEach(sec => sec.style.display = 'none');
                    if (sections[target]) {
                        sections[target].style.display = 'block';
                        if (target === 'excuses') loadExcuses();
                        if (target === 'calendar') loadCalendar();
                    }
                });
            });

            // Load Attendance Summary
            const loadStats = async () => {
                const today = new Date();
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(today.getDate() - 30);
                
                const summaryRes = await apiFetch(`/api/student/summary?start=${thirtyDaysAgo.toISOString().split('T')[0]}&end=${today.toISOString().split('T')[0]}`);
                if (summaryRes && summaryRes.success) {
                    const stats = summaryRes.data;
                    document.getElementById('statPresent').textContent = stats.Present || 0;
                    document.getElementById('statAbsent').textContent = stats.Absent || 0;
                    document.getElementById('statLate').textContent = stats.Late || 0;
                }
            };
            loadStats();

            // Calendar Logic
            const loadCalendar = async () => {
                const calendarEl = document.getElementById('attendanceCalendar');
                
                // Fetch data
                const response = await apiFetch('/api/student/attendance-history');
                let events = [];
                if (response && response.success) {
                    events = response.data.map(rec => {
                        let color = '#3b82f6'; // default primary
                        if (rec.status === 'Present') color = '#16a34a'; // green
                        else if (rec.status === 'Absent') color = '#dc2626'; // red
                        else if (rec.status === 'Late') color = '#f97316'; // orange
                        
                        // Handle time format
                        let start = rec.date;
                        if (rec.time && rec.time !== '--') {
                            start += 'T' + rec.time;
                        }

                        const roomInfo = rec.room_number ? `Rm ${rec.room_number}` : '';

                        return {
                            title: `${rec.code || 'Class'} ${roomInfo}`,
                            start: start,
                            color: color,
                            allDay: !rec.time || rec.time === '--',
                            extendedProps: {
                                status: rec.status,
                                course: rec.name,
                                time: rec.time,
                                room: rec.room_name ? `${rec.room_name} (${rec.room_number})` : '',
                                teacher: rec.teacher_name
                            }
                        };
                    });
                }

                if (!calendar) {
                    calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridMonth,listMonth'
                        },
                        events: events,
                        height: 'auto',
                        eventClick: function(info) {
                            const props = info.event.extendedProps;
                            const timeStr = info.event.allDay ? '' : ` at ${props.time}`;
                            const roomStr = props.room ? ` in ${props.room}` : '';
                            const teacherStr = props.teacher ? ` by ${props.teacher}` : '';
                            showMessage(`${props.course}: ${props.status}${timeStr}${roomStr}${teacherStr}`);
                        }
                    });
                    calendar.render();
                } else {
                    calendar.removeAllEvents();
                    calendar.addEventSource(events);
                    calendar.render();
                }
            };

            // Download PDF Report Logic
            const downloadPdfBtn = document.getElementById('downloadPdfBtn');
            downloadPdfBtn.addEventListener('click', async () => {
                downloadPdfBtn.disabled = true;
                downloadPdfBtn.textContent = 'Generating...';
                
                try {
                    const response = await apiFetch('/api/student/attendance-history');
                    if (response && response.success) {
                        const records = response.data;
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();
                        
                        // Header
                        doc.setFontSize(18);
                        doc.text('Student Attendance Report', 14, 22);
                        
                        doc.setFontSize(11);
                        doc.setTextColor(100);
                        const studentName = document.getElementById('welcomeMsg').textContent.replace('Welcome, ', '').replace('!', '');
                        doc.text(`Student: ${studentName}`, 14, 32);
                        doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 38);
                        
                        // Table
                        const tableColumn = ["Date", "Course", "Time", "Status"];
                        const tableRows = [];

                        records.forEach(rec => {
                            const courseStr = rec.code ? `${rec.code} - ${rec.name}` : 'N/A';
                            const rowData = [
                                rec.date,
                                courseStr,
                                rec.time,
                                rec.status
                            ];
                            tableRows.push(rowData);
                        });

                        doc.autoTable({
                            head: [tableColumn],
                            body: tableRows,
                            startY: 45,
                            theme: 'grid',
                            styles: { fontSize: 10 },
                            headStyles: { fillColor: [59, 130, 246] } // var(--primary)
                        });

                        doc.save(`attendance_report_${new Date().toISOString().split('T')[0]}.pdf`);
                    } else {
                        showMessage('Failed to fetch attendance records.', 'error');
                    }
                } catch (err) {
                    console.error(err);
                    showMessage('Error generating PDF.', 'error');
                } finally {
                    downloadPdfBtn.disabled = false;
                    downloadPdfBtn.textContent = 'Download Report (PDF)';
                }
            });

            // Load Announcements
            const annRes = await apiFetch('/api/announcements');
            const annContainer = document.getElementById('announcementsContainer');
            annContainer.innerHTML = '';
            
            if (annRes && annRes.success && annRes.data.length > 0) {
                annRes.data.forEach(a => {
                    const div = document.createElement('div');
                    div.className = 'announcement-card';
                    div.innerHTML = `
                        <h4 style="margin: 0 0 5px 0; font-size: 18px;">${a.title}</h4>
                        <span class="announcement-meta">Posted by ${a.author_name} on ${new Date(a.created_at).toLocaleDateString()}</span>
                        <p style="margin: 0; line-height: 1.5;">${a.content}</p>
                    `;
                    annContainer.appendChild(div);
                });
            } else {
                annContainer.innerHTML = '<p>No announcements at this time.</p>';
            }

            // Excuses Logic
            const excuseForm = document.getElementById('excuseForm');
            const excusesTableBody = document.getElementById('excusesTable').querySelector('tbody');

            async function loadExcuses() {
                excusesTableBody.innerHTML = getLoadingHTML(3);
                const response = await apiFetch('/api/student/excuses');
                if (response && response.success) {
                    const excuses = response.data;
                    excusesTableBody.innerHTML = '';
                    if (excuses.length === 0) {
                        excusesTableBody.innerHTML = '<tr><td colspan="3">No excuses submitted.</td></tr>';
                        return;
                    }
                    excuses.forEach(exc => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${exc.date}</td>
                            <td>${exc.reason}</td>
                            <td><span class="status-${exc.status}">${exc.status}</span></td>
                        `;
                        excusesTableBody.appendChild(tr);
                    });
                } else {
                    excusesTableBody.innerHTML = '<tr><td colspan="3">Error loading excuses.</td></tr>';
                }
            }

            excuseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = excuseForm.querySelector('button');
                btn.disabled = true;
                
                const data = {
                    date: document.getElementById('excuseDate').value,
                    reason: document.getElementById('excuseReason').value
                };

                const response = await apiFetch('/api/student/excuse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response && response.success) {
                    showMessage('Excuse submitted successfully.');
                    excuseForm.reset();
                    loadExcuses();
                }
                btn.disabled = false;
            });

            // Settings Logic
            const changePasswordForm = document.getElementById('changePasswordForm');
            changePasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (newPassword !== confirmPassword) {
                    showMessage('New passwords do not match.', 'error');
                    return;
                }

                const btn = changePasswordForm.querySelector('button');
                btn.disabled = true;

                const response = await apiFetch('/api/user/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentPassword, newPassword })
                });

                if (response && response.success) {
                    showMessage('Password updated successfully.');
                    changePasswordForm.reset();
                }
                btn.disabled = false;
            });

            // --- Mark Attendance Modal Logic ---
            const markAttendanceModal = document.getElementById('markAttendanceModal');
            const openMarkAttendanceBtn = document.getElementById('openMarkAttendanceBtn');
            const closeMarkAttendanceBtn = document.getElementById('closeMarkAttendanceBtn');
            const markAttendanceForm = document.getElementById('markAttendanceForm');
            const attendanceCodeInput = document.getElementById('attendanceCode');

            // Clock Logic
            const updateClock = () => {
                const now = new Date();
                const clockEl = document.getElementById('digitalClock');
                const dateEl = document.getElementById('currentDate');
                if (clockEl) clockEl.textContent = now.toLocaleTimeString([], { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                if (dateEl) dateEl.textContent = now.toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            };
            setInterval(updateClock, 1000);
            updateClock();

            openMarkAttendanceBtn.addEventListener('click', (e) => {
                e.preventDefault();
                markAttendanceModal.style.display = 'flex';
                attendanceCodeInput.value = '';
                attendanceCodeInput.focus();
            });

            const closeMarkAttendanceModal = () => {
                markAttendanceModal.style.display = 'none';
            };

            closeMarkAttendanceBtn.addEventListener('click', closeMarkAttendanceModal);
            window.addEventListener('click', (e) => { if (e.target === markAttendanceModal) closeMarkAttendanceModal(); });

            attendanceCodeInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
            });

            markAttendanceForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = markAttendanceForm.querySelector('button[type="submit"]');
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = 'Verifying...';

                const response = await apiFetch('/api/student/attendance/mark', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: attendanceCodeInput.value.trim() })
                });

                if (response && response.success) {
                    showMessage(response.data.message);
                    closeMarkAttendanceModal();
                    loadStats(); // Refresh dashboard stats
                }
                btn.disabled = false;
                btn.textContent = originalText;
            });
        });
    </script>
</body>
</html>